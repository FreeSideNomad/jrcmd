<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: layout(~{::title}, ~{::content})}">
<head>
    <title>New Payment Batch - E2E Test App</title>
</head>
<body>
<div th:fragment="content">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">Dashboard</a></li>
            <li class="breadcrumb-item"><a th:href="@{/payments}">Payments</a></li>
            <li class="breadcrumb-item active">New Batch</li>
        </ol>
    </nav>

    <h2 class="mb-4">Create Payment Batch</h2>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Scenario Presets</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Load Scenario</label>
                    <select id="scenarioPreset" class="form-select" onchange="applyScenario()">
                        <option value="">-- Select Preset --</option>
                        <option value="single-payment">Single Payment (Clean)</option>
                        <option value="chaos">Chaos Testing</option>
                    </select>
                    <small class="text-muted">Select a preset to auto-fill form values</small>
                </div>
                <div class="col-md-8">
                    <div id="scenarioDescription" class="alert alert-info mb-0 mt-4" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <form th:action="@{/payments/batch}" method="post">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Basic Settings</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Batch Name</label>
                        <input type="text" name="name" class="form-control" required
                               th:value="${request.name()}" placeholder="My Payment Batch">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Count</label>
                        <input type="number" name="count" class="form-control" min="1" max="1000000"
                               th:value="${request.count()}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Execution Model</label>
                        <select name="executionModel" class="form-select">
                            <option value="COMMAND_BASED" th:selected="${request.executionModel() == null or request.executionModel() == 'COMMAND_BASED'}">
                                COMMAND_BASED
                            </option>
                            <option value="STEP_BASED" th:selected="${request.executionModel() == 'STEP_BASED'}">
                                STEP_BASED
                            </option>
                            <option value="COMMAND_STEP" th:selected="${request.executionModel() == 'COMMAND_STEP'}">
                                COMMAND_STEP
                            </option>
                        </select>
                        <small class="text-muted">Workflow execution approach</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Min Amount</label>
                        <input type="number" name="minAmount" class="form-control" step="0.01"
                               th:value="${request.minAmount()}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Max Amount</label>
                        <input type="number" name="maxAmount" class="form-control" step="0.01"
                               th:value="${request.maxAmount()}">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Debit Currency</label>
                        <select name="debitCurrency" class="form-select">
                            <option th:each="c : ${currencies}" th:value="${c}" th:text="${c}"
                                    th:selected="${c == request.debitCurrency()}">Currency</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Credit Currency</label>
                        <select name="creditCurrency" class="form-select">
                            <option th:each="c : ${currencies}" th:value="${c}" th:text="${c}"
                                    th:selected="${c == request.creditCurrency()}">Currency</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Value Date</label>
                        <input type="date" name="valueDate" class="form-control"
                               th:value="${request.valueDate()}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Cutoff (hours)</label>
                        <input type="number" name="cutoffHours" class="form-control"
                               min="0.1" max="168" step="0.1" th:value="${request.cutoffHours()}">
                        <small class="text-muted">e.g., 0.5 = 30 minutes</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>Risk Behavior</h5>
                <small class="text-muted">Configure approval methods and failure rates for BookTransactionRisk step</small>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-2">
                        <label class="form-label">Balance %</label>
                        <input type="number" name="riskApprovedBalancePct" class="form-control"
                               min="0" max="100" step="0.1" value="70">
                        <small class="text-muted">Approved via balance</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Limit %</label>
                        <input type="number" name="riskApprovedLimitPct" class="form-control"
                               min="0" max="100" step="0.1" value="20">
                        <small class="text-muted">Approved via limit</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Manual %</label>
                        <input type="number" name="riskManualApprovalPct" class="form-control"
                               min="0" max="100" step="0.1" value="5">
                        <small class="text-muted">Requires UI approval</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Declined %</label>
                        <input type="number" name="riskDeclinedPct" class="form-control"
                               min="0" max="100" step="0.1" value="5">
                        <small class="text-muted">Declined</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Min ms</label>
                        <input type="number" name="riskMinMs" class="form-control"
                               min="0" max="10000" value="50">
                        <small class="text-muted">Processing time</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Max ms</label>
                        <input type="number" name="riskMaxMs" class="form-control"
                               min="0" max="10000" value="200">
                        <small class="text-muted">Processing time</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>Step Behavior Configuration</h5>
                <small class="text-muted">Configure failure rates and durations for FX, Submit, and L1-L4 steps</small>
            </div>
            <div class="card-body">
                <!-- FX Step -->
                <h6 class="border-bottom pb-2">Book FX (cross-currency only)</h6>
                <div class="row mb-3">
                    <div class="col-md-2">
                        <label class="form-label">Perm Fail %</label>
                        <input type="number" name="fxFailPerm" class="form-control"
                               min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Trans Fail %</label>
                        <input type="number" name="fxFailTrans" class="form-control"
                               min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Biz Rule %</label>
                        <input type="number" name="fxFailBiz" class="form-control"
                               min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Timeout %</label>
                        <input type="number" name="fxTimeout" class="form-control"
                               min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Min ms</label>
                        <input type="number" name="fxMinMs" class="form-control"
                               min="0" max="10000" value="10">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Max ms</label>
                        <input type="number" name="fxMaxMs" class="form-control"
                               min="0" max="10000" value="100">
                    </div>
                </div>

                <!-- Submit Step -->
                <h6 class="border-bottom pb-2 mt-4">Submit Payment</h6>
                <div class="row mb-3">
                    <div class="col-md-2">
                        <label class="form-label">Perm Fail %</label>
                        <input type="number" name="submitFailPerm" class="form-control"
                               min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Trans Fail %</label>
                        <input type="number" name="submitFailTrans" class="form-control"
                               min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Biz Rule %</label>
                        <input type="number" name="submitFailBiz" class="form-control"
                               min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Timeout %</label>
                        <input type="number" name="submitTimeout" class="form-control"
                               min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Min ms</label>
                        <input type="number" name="submitMinMs" class="form-control"
                               min="0" max="10000" value="10">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Max ms</label>
                        <input type="number" name="submitMaxMs" class="form-control"
                               min="0" max="10000" value="100">
                    </div>
                </div>

                <!-- L1-L4 Steps (compact view) -->
                <h6 class="border-bottom pb-2 mt-4">Network Confirmations (L1-L4)</h6>
                <small class="text-muted mb-3 d-block">These control the simulated payment network reply behavior</small>

                <!-- Header row -->
                <div class="row mb-2 text-muted small">
                    <div class="col-1">Level</div>
                    <div class="col-2">Perm Fail %</div>
                    <div class="col-2">Trans Fail %</div>
                    <div class="col-2">Biz Rule %</div>
                    <div class="col-1">Timeout %</div>
                    <div class="col-1">Pending %</div>
                    <div class="col-1">Min ms</div>
                    <div class="col-1">Max ms</div>
                </div>

                <div th:each="level : ${ {1, 2, 3, 4} }" class="row mb-2">
                    <div class="col-1 d-flex align-items-center">
                        <strong th:text="${'L' + level}">L1</strong>
                    </div>
                    <div class="col-2">
                        <input type="number" th:name="${'l' + level + 'FailPerm'}" class="form-control form-control-sm"
                               min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="col-2">
                        <input type="number" th:name="${'l' + level + 'FailTrans'}" class="form-control form-control-sm"
                               min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="col-2">
                        <input type="number" th:name="${'l' + level + 'FailBiz'}" class="form-control form-control-sm"
                               min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="col-1">
                        <input type="number" th:name="${'l' + level + 'Timeout'}" class="form-control form-control-sm"
                               min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="col-1">
                        <input th:if="${level == 3 or level == 4}" type="number" th:name="${'l' + level + 'Pending'}"
                               class="form-control form-control-sm" min="0" max="100" step="0.1" value="0">
                        <span th:if="${level == 1 or level == 2}" class="text-muted">-</span>
                    </div>
                    <div class="col-1">
                        <input type="number" th:name="${'l' + level + 'MinMs'}" class="form-control form-control-sm"
                               min="0" max="10000" value="10">
                    </div>
                    <div class="col-1">
                        <input type="number" th:name="${'l' + level + 'MaxMs'}" class="form-control form-control-sm"
                               min="0" max="10000" value="100">
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2">
            <a th:href="@{/payments}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">Create Payment Batch</button>
        </div>
    </form>

    <script>
        const scenarios = {
            'single-payment': {
                description: '<strong>Single Payment (Clean):</strong> 1 payment, STEP_BASED execution, instant processing (0ms), 100% balance-based risk approval, no failures.',
                values: {
                    // Basic settings
                    count: 1,
                    executionModel: 'STEP_BASED',
                    // Risk behavior - 100% balance, all others 0
                    riskApprovedBalancePct: 100,
                    riskApprovedLimitPct: 0,
                    riskManualApprovalPct: 0,
                    riskDeclinedPct: 0,
                    riskMinMs: 0,
                    riskMaxMs: 0,
                    // FX step - all 0
                    fxFailPerm: 0,
                    fxFailTrans: 0,
                    fxFailBiz: 0,
                    fxTimeout: 0,
                    fxMinMs: 0,
                    fxMaxMs: 0,
                    // Submit step - all 0
                    submitFailPerm: 0,
                    submitFailTrans: 0,
                    submitFailBiz: 0,
                    submitTimeout: 0,
                    submitMinMs: 0,
                    submitMaxMs: 0,
                    // L1-L4 - all 0
                    l1FailPerm: 0, l1FailTrans: 0, l1FailBiz: 0, l1Timeout: 0, l1MinMs: 0, l1MaxMs: 0,
                    l2FailPerm: 0, l2FailTrans: 0, l2FailBiz: 0, l2Timeout: 0, l2MinMs: 0, l2MaxMs: 0,
                    l3FailPerm: 0, l3FailTrans: 0, l3FailBiz: 0, l3Timeout: 0, l3Pending: 0, l3MinMs: 0, l3MaxMs: 0,
                    l4FailPerm: 0, l4FailTrans: 0, l4FailBiz: 0, l4Timeout: 0, l4Pending: 0, l4MinMs: 0, l4MaxMs: 0
                }
            },
            'chaos': {
                description: '<strong>Chaos Testing:</strong> 1 payment, STEP_BASED, realistic delays. Failures: 3% timeout, 3% business rule, 20% transient (retryable), 3% manual approval required.',
                values: {
                    // Basic settings
                    count: 1,
                    executionModel: 'STEP_BASED',
                    // Risk behavior - 94% balance, 3% manual approval
                    riskApprovedBalancePct: 94,
                    riskApprovedLimitPct: 0,
                    riskManualApprovalPct: 3,
                    riskDeclinedPct: 3,
                    riskMinMs: 50,
                    riskMaxMs: 200,
                    // FX step - chaos percentages
                    fxFailPerm: 0,
                    fxFailTrans: 20,
                    fxFailBiz: 3,
                    fxTimeout: 3,
                    fxMinMs: 50,
                    fxMaxMs: 200,
                    // Submit step - chaos percentages
                    submitFailPerm: 0,
                    submitFailTrans: 20,
                    submitFailBiz: 3,
                    submitTimeout: 3,
                    submitMinMs: 50,
                    submitMaxMs: 200,
                    // L1-L4 - chaos percentages
                    l1FailPerm: 0, l1FailTrans: 20, l1FailBiz: 3, l1Timeout: 3, l1MinMs: 50, l1MaxMs: 200,
                    l2FailPerm: 0, l2FailTrans: 20, l2FailBiz: 3, l2Timeout: 3, l2MinMs: 50, l2MaxMs: 200,
                    l3FailPerm: 0, l3FailTrans: 20, l3FailBiz: 3, l3Timeout: 3, l3Pending: 3, l3MinMs: 50, l3MaxMs: 200,
                    l4FailPerm: 0, l4FailTrans: 20, l4FailBiz: 3, l4Timeout: 3, l4Pending: 3, l4MinMs: 50, l4MaxMs: 200
                }
            }
        };

        function applyScenario() {
            const select = document.getElementById('scenarioPreset');
            const descDiv = document.getElementById('scenarioDescription');
            const scenario = scenarios[select.value];

            if (!scenario) {
                descDiv.style.display = 'none';
                return;
            }

            // Show description
            descDiv.innerHTML = scenario.description;
            descDiv.style.display = 'block';

            // Apply values
            for (const [name, value] of Object.entries(scenario.values)) {
                const input = document.querySelector(`[name="${name}"]`);
                if (input) {
                    input.value = value;
                }
            }
        }
    </script>
</div>
</body>
</html>
