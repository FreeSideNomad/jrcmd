<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: layout(~{::title}, ~{::content})}">
<head>
    <title>Batches - E2E Test App</title>
</head>
<body>
<div th:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-collection"></i> Batches</h2>
        <a th:href="@{/batches/new}" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Create Batch
        </a>
    </div>

    <form class="row g-3 mb-4" th:action="@{/batches}" method="get">
        <div class="col-auto">
            <select name="status" class="form-select">
                <option value="">All Statuses</option>
                <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"
                        th:selected="${s == status}"></option>
            </select>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Filter</button>
            <a th:href="@{/batches}" class="btn btn-secondary">Clear</a>
        </div>
    </form>

    <div th:if="${batches.isEmpty()}" class="alert alert-info">
        No batches found.
    </div>

    <div th:unless="${batches.isEmpty()}" class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Batch ID</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Created At</th>
                    <th>Completed At</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="batch : ${batches}" class="clickable-row" th:data-href="@{/batches/{id}(id=${batch.batchId})}">
                    <td><code class="uuid-short" th:text="${#strings.abbreviate(batch.batchId.toString(), 12)}">uuid</code></td>
                    <td>
                        <span class="badge"
                              th:classappend="${batch.status.name() == 'COMPLETED'} ? 'bg-success' :
                                              (${batch.status.name() == 'FAILED'} ? 'bg-danger' :
                                              (${batch.status.name() == 'IN_PROGRESS'} ? 'bg-primary' : 'bg-secondary'))"
                              th:text="${batch.status}">STATUS</span>
                    </td>
                    <td>
                        <div class="progress progress-sm" style="width: 120px">
                            <div class="progress-bar bg-success" role="progressbar"
                                 th:style="'width: ' + ${(batch.completedCount * 100) / (batch.totalCount > 0 ? batch.totalCount : 1)} + '%'"
                                 th:title="${batch.completedCount + ' completed'}">
                            </div>
                            <div class="progress-bar bg-danger" role="progressbar"
                                 th:style="'width: ' + ${(batch.failedCommands() * 100) / (batch.totalCount > 0 ? batch.totalCount : 1)} + '%'"
                                 th:title="${batch.failedCommands() + ' failed/tsq'}">
                            </div>
                        </div>
                        <small>
                            <span class="text-success" th:text="${batch.completedCount}">0</span>/<span
                            class="text-danger" th:if="${batch.failedCommands() > 0}" th:text="${batch.failedCommands()}">0</span><span
                            th:if="${batch.failedCommands() > 0}">/</span><span th:text="${batch.totalCount}">0</span>
                        </small>
                    </td>
                    <td><code th:text="${#temporals.format(batch.createdAt, 'HH:mm:ss.SSSSSS')}">time</code></td>
                    <td><code th:text="${batch.completedAt != null ? #temporals.format(batch.completedAt, 'HH:mm:ss.SSSSSS') : 'N/A'}">time</code></td>
                </tr>
            </tbody>
        </table>
    </div>
    <script th:inline="javascript">
        document.querySelectorAll('.clickable-row').forEach(row => {
            row.style.cursor = 'pointer';
            row.addEventListener('click', () => window.location = row.dataset.href);
        });

        // Auto-refresh every 5 seconds if any batch is in progress
        (function() {
            const batches = /*[[${batches}]]*/ [];
            const hasInProgress = batches.some(b => b.status === 'PENDING' || b.status === 'IN_PROGRESS');
            if (hasInProgress) {
                setTimeout(() => window.location.reload(), 5000);
            }
        })();
    </script>
</div>
</body>
</html>
